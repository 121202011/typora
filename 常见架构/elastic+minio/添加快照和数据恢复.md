本文章主要用于elastic如何添加快照备份，如何跨集群迁移迁移，这里使用minio去存储快照（也可使用s3，oss等资源）

#### 环境准备：

minio安装部署（这里使用docker方式快速部署），登录console界面创建对应的桶名

```shell
mkdir -p /opt/minio/data
docker run --privileged=true --net=host \
-d --name minio1 \
  -v /opt/minio/data:/data \
  -e "MINIO_ROOT_USER=admin" \
  -e "MINIO_ROOT_PASSWORD=CIICsh123," \
  harbor.ciicsh.com/base/minio:RELEASE.2023-02-27T18-10-45Z server /data --console-address ":9001"
```

#### es集群安装部署

docker-compose.yml文件配置

```shell
version: '3.8'

services:
  elasticsearch:
    image: "harbor.ciicsh.com/library/elasticsearch:8.17.6"
    container_name: es
    environment:
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2048m -Xmx2048m"
      - "ELASTIC_PASSWORD=Elastic@123!"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - /opt/elasticsearch/data:/usr/share/elasticsearch/data
      - /opt/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - /opt/elasticsearch/elastic-stack-ca.p12:/usr/share/elasticsearch/config/elastic-stack-ca.p12
      - /opt/elasticsearch/elastic-certificates.p12:/usr/share/elasticsearch/config/elastic-certificates.p12
    restart: always
    ports:
      - 9200:9200
      - 9300:9300
    network_mode: "host"
```

配置文件

```shell
[root@DEV-OPS-DEPLOY02 elasticsearch 10:12:43 ]$ cat elasticsearch.yml
#node
cluster.name: vhrelastic
node.name: DEV-OPS-DEPLOY02
network.host: 172.16.8.202
http.port: 9200
transport.port: 9300


# 从生效的hosts列表获取所有节点IP
discovery.seed_hosts: ["172.16.8.202", "172.16.8.203", "172.16.8.204"]

# 获取第一个设置了initial_master=true的主机

cluster.initial_master_nodes: ["DEV-OPS-DEPLOY02"]

#跨站访问
http.cors.enabled: true
http.cors.allow-origin: "*"
http.cors.allow-headers: Authorization
#X-Pack
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/elastic-certificates.p12

#minio
s3.client.default.endpoint: 172.16.8.201:9000
s3.client.default.protocol: http

```

注意事项：

1.如果是集群每台es都需要执行添加minio账号密码操作
2.每台es配置文件都需要指向es地址配置
3.重启es使配置生效
4.es8版本后面就不需要再安装插件repository-s3

添加配置文件（所有es都要添加）

```shell
#minio
s3.client.default.endpoint: 172.16.8.201:9000
s3.client.default.protocol: http
```

重启后需添加minio账号密码

```shell

bin/elasticsearch-keystore add s3.client.default.access_key
# 输入值：admin
bin/elasticsearch-keystore add s3.client.default.secret_key
# 输入值：CIICsh123,

```

添加快照仓库

```shell
curl --basic -u elastic:Elastic@123! -X PUT "http://172.16.8.202:9200/_snapshot/mys3_repo" -H 'Content-Type: application/json' -d '{
  "type": "s3",
  "settings": {
    "bucket": "es-bak"
  }
}'

--basic：使用 HTTP 基本认证（用户名 + 密码）
-u elastic:Elastic@123!：指定 Elasticsearch 的管理员账号和密码，用于验证身份
-X PUT：HTTP 方法为 PUT，用于创建新资源或更新现有资源
_snapshot/mys3_repo：Elasticsearch 的快照仓库管理接口，mys3_repo 是自定义的仓库名称
http://172.16.8.202:9200：Elasticsearch 集群中任一节点的地址和端口
-H 'Content-Type: application/json' 声明请求体的数据格式为 JSON
type: "s3"：指定仓库类型为 S3 兼容存储（Elasticsearch 还支持 fs 本地文件、gcs 谷歌云存储等类型）
settings.bucket: "es-bak"：指定存储快照的 S3 桶名称
```

备份索引

```shell
只添加业务索引快照
curl --basic -u elastic:Elastic@123! -X PUT "http://172.16.8.202:9200/_snapshot/mys3_repo/full_snapsho4_20250813?wait_for_completion=true" -H 'Content-Type: application/json' -d '{
  "indices": "*,-.*",
  "include_global_state": false
}'


备份所有索引（全量快照）
curl --basic -u elastic:Elastic@123! -X PUT "http://172.16.8.202:9200/_snapshot/mys3_repo/full_snapshot_20250812?wait_for_completion=true" -H 'Content-Type: application/json' -d '{
  "indices": "*",
  "include_global_state": false
}'


--basic: 使用基本认证方式
-u elastic:Elastic@123!: 认证的用户名 (elastic) 和密码 (Elastic@123!)
-X PUT: 使用 HTTP 的 PUT 方法
_snapshot: Elasticsearch 快照 API 的固定前缀
mys3_repo: 快照仓库名称
full_snapsho4_20250813: 要创建的快照名称
wait_for_completion=true: 表示命令会等待快照创建完成后再返回，而不是立即返回 (默认行为)
-H 'Content-Type: application/json': 声明请求体为 JSON 格式
* 表示匹配所有索引
-. 表示排除所有以.开头的系统索引
include_global_state: false: 不恢复源集群全局配置

```

==新集群也需添加es相关配置和minio相关账号和密码（每台机器都需要）新集群也需要添加快照存储库和源集群名称保持一致（具体操作如上）==

目标集群恢复数据

```shell
只恢复业务级别（若快照是全局恢复时可进行筛选）
curl --basic -u elastic:Elastic@123! -X POST "http://172.16.8.202:9200/_snapshot/mys3_repo/full_snapshot_20250812/_restore" -H 'Content-Type: application/json' -d '{
  "indices": "*,-.*",  # 恢复所有非系统索引（排除以 . 开头的索引）
  "include_global_state": false  # 不恢复源集群全局配置
}'



恢复整个快照
curl --basic -u elastic:Elastic@123! -X POST "http://172.16.8.202:9200/_snapshot/mys3_repo/full_snapshot_20250812/_restore?pretty"


恢复时排除系统索引（仅恢复业务索引），更改了索引名
curl -u elastic:password -X POST "http://es-host:9200/_snapshot/my_repo/my_snapshot/_restore?pretty" -H "Content-Type: application/json" -d '
{
  "indices": "*",  // 恢复所有索引
  "rename_pattern": "(.+)",  // 匹配所有索引
  "rename_replacement": "migrated_$1",  // 重命名为migrated_前缀+原名称
  "include_global_state": false  // 不恢复集群全局配置
}
'

```

