

| 服务名称 | 下载地址                           | 备注 |
| -------- | ---------------------------------- | ---- |
| kafka    | https://kafka.apache.org/downloads |      |



### 1. 安装 Kafka

#### 解压 Kafka 安装包

```bash
# 解压 Kafka 安装包（版本 2.13-3.1.0）
tar -xzf kafka_2.13-3.1.0.tgz
```

#### 创建软链接

```bash
# 创建软链接便于版本管理
ln -s kafka_2.13-3.1.0 kafka
```

#### 创建数据存储目录

```bash
# 进入 Kafka 目录
cd kafka

# 创建 ZooKeeper 数据目录
mkdir -p /opt/zookeeper/data
mkdir -p /opt/kafka/logs/
```

### 2. ZooKeeper 配置

#### 备份并编辑 ZooKeeper 配置文件

```bash
# 备份原始配置文件
cp config/zookeeper.properties config/zookeeper.properties.bak

# 编辑 ZooKeeper 配置
vim config/zookeeper.properties

# 基本时间单位（毫秒）
tickTime=2000
# 初始化同步时最长心跳间隔
initLimit=10
# 心跳包发送与接收时间限制
syncLimit=5
# 数据存储目录
dataDir=/opt/zookeeper/data
# 客户端连接端口
clientPort=2181
```

#### 配置服务器标识

```bash

echo "1" > /opt/zookeeper/data/myid
```

### 3. Kafka 配置

#### 备份并编辑 Kafka 配置文件

```bash
# 备份原始配置文件
cp config/server.properties config/server.properties.bak

```

#### Kafka 配置内容

```bash
vim config/server.properties

# Broker 唯一标识（每台服务器不同）
broker.id=1
# 服务器主机名或IP（每台服务器设置为自己的IP）
host.name=172.24.100.186
# 处理网络请求的线程数
num.network.threads=3
# 处理磁盘I/O的线程数
num.io.threads=8
# 发送缓冲区大小
socket.send.buffer.bytes=102400
# 接收缓冲区大小
socket.receive.buffer.bytes=102400
# 请求最大值
socket.request.max.bytes=104857600
# 日志存储目录
log.dirs=/opt/kafka/logs/
# 默认分区数
num.partitions=1
# 恢复数据时使用的线程数
num.recovery.threads.per.data.dir=1
# 偏移量主题的副本因子
offsets.topic.replication.factor=1
# 事务状态日志的副本因子
transaction.state.log.replication.factor=1
# 事务状态日志的最小同步副本数
transaction.state.log.min.isr=1
# 日志清理策略
log.cleanup.policy=delete
# 日志保留时间（小时）
log.retention.hours=168
# 日志段文件大小
log.segment.bytes=1073741824
# 日志保留检查间隔
log.retention.check.interval.ms=300000
# ZooKeeper 连接地址
zookeeper.connect=172.24.100.186:2181
# ZooKeeper 连接超时时间
zookeeper.connection.timeout.ms=6000
# 消费者组再平衡延迟
group.initial.rebalance.delay.ms=0

# 安全认证配置
# 使用SASL_PLAINTEXT协议监听
listeners=SASL_PLAINTEXT://172.24.100.186:9092
# Broker间通信使用的安全协议
security.inter.broker.protocol=SASL_PLAINTEXT
# Broker间通信使用的SASL机制
sasl.mechanism.inter.broker.protocol=PLAIN
# 启用的SASL机制
sasl.enabled.mechanisms=PLAIN

# 权限控制配置
# 使用ACL授权器
authorizer.class.name=kafka.security.authorizer.AclAuthorizer
# 超级用户（拥有所有权限）
super.users=User:admin
```

### 4. 安全认证配置

#### 创建 JAAS 配置文件

```bash
# 创建 Kafka 服务器认证配置文件
vim config/kafka_server_jaas.conf

KafkaServer {  // 定义Kafka服务器的JAAS配置上下文
   org.apache.kafka.common.security.plain.PlainLoginModule required  // 使用PLAIN登录模块，且此模块为必需
   username="admin"  // Broker间通信使用的用户名
   password="jZ1]uD3&uP4-wZ"  // Broker间通信使用的密码
   user_admin="jZ1]uD3&uP4-wZ"  // 定义用户admin及其密码
   user_log="cC4_zM0]nF3!nH";  // 定义用户log及其密码
};
```

#### 修改启动脚本以加载 JAAS 配置

```bash
# 编辑 Kafka 启动类脚本
vim bin/kafka-run-class.sh

# 在文件更改以下环境变量（243左右）
export KAFKA_OPTS="-Djava.security.auth.login.config=/opt/kafka/config/kafka_server_jaas.conf"
```

#### 创建客户端认证配置文件

```bash
# 创建普通用户客户端认证配置
vim config/kafka_client_auth.conf

security.protocol=SASL_PLAINTEXT
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="log" password="cC4_zM0]nF3!nH";
```

```bash
# 创建管理员客户端认证配置
vim config/kafka_client_auth_admin.conf

security.protocol=SASL_PLAINTEXT
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="jZ1]uD3&uP4-wZ";
```

### 5. 服务管理

#### 启动和停止服务

```bash
# 启动 ZooKeeper 服务（后台运行）
./bin/zookeeper-server-start.sh -daemon config/zookeeper.properties

# 停止 ZooKeeper 服务
./bin/zookeeper-server-stop.sh

# 启动 Kafka 服务（后台运行）
./bin/kafka-server-start.sh -daemon config/server.properties

# 停止 Kafka 服务
./bin/kafka-server-stop.sh
```

#### 验证服务状态

```bash
# 使用管理员账户查看 Topic 列表
./bin/kafka-topics.sh --bootstrap-server 172.24.100.186:9092 --list --command-config config/kafka_client_auth_admin.conf

# 使用普通用户账户查看 Topic 列表
./bin/kafka-topics.sh --bootstrap-server 172.24.100.186:9092 --list --command-config config/kafka_client_auth.conf
```

### 6.Kafka ACL 权限管理命令

1. 为zhaopin用户添加对zhaopin-logger主题的读权限：

```bash
kafka-acls.sh --bootstrap-server 172.24.100.186:9092 --command-config /opt/kafka/config/kafka_client_auth_admin.conf --add --allow-principal User:zhaopin --operation Read --topic zhaopin-logger
```

  2.为wjdc用户添加对[wjdc.biz](https://wjdc.biz/)AuditLog主题的读写权限：

```bash
kafka-acls.sh --bootstrap-server 172.24.100.186:9092 --command-config /opt/kafka/config/kafka_client_auth_admin.conf --add --allow-principal User:wjdc --operation Write --operation Read --topic wjdc.bizAuditLog
```

  3.列出所有ACL规则（使用bootstrap-server）：

```bash
kafka-acls.sh --bootstrap-server 172.24.100.186:9092 --command-config /opt/kafka/config/kafka_client_auth_admin.conf --list
```

