# 环境准备

```shell
环境准备
1.创建数据库zhaopin和rck
2.创建用户zhaopin和rck，并绑定数据库zhaopin和rck
3.分别在数据库下创建模式zhaopin和rck
4.在两个数据库zhaopin和rck下的zhaopin和rck模式下插入数据
```

```shell
创建用户zhaopin和rck
create user zhaopin with password 'CIICsh123,';
create user rck with password 'CIICsh123,';

创建数据库并绑定用户所有者
create database zhaopin owner=zhaopin;
create database rck owner=rck;

指定用户切换数据库
\c zhaopin zhaopin;
\c rck rck;

创建模式并绑定模式的所有者
create schema zhaopin authorization zhaopin;
create schema rck authorization rck;

##zhaopin用户切换到zhaopin库
-- 在zhaopin模式下创建表
CREATE TABLE zhaopin.job (
    id SERIAL PRIMARY KEY,  -- 自增ID
    job_name VARCHAR(100) NOT NULL,  -- 职位名称
    company VARCHAR(100) NOT NULL,  -- 公司名称
    salary INT,  -- 薪资（单位：千/月）
    publish_date DATE  -- 发布日期
);

查看表结构
\d zhaopin.job;

-- 设置当前会话默认使用 zhaopin 模式
SET search_path TO zhaopin;

数据插入
INSERT INTO zhaopin.job (job_name, company, salary, publish_date) VALUES
('Java开发工程师', '科技有限公司A', 15, '2025-08-01'),
('前端开发工程师', '互联网公司B', 12, '2025-08-02'),
('产品经理', '数据服务公司C', 18, '2025-08-03'),
('UI设计师', '设计工作室D', 10, '2025-08-04'),
('测试工程师', '软件公司E', 13, '2025-08-05'),
('运维工程师', '云服务公司F', 14, '2025-08-06'),
('数据分析师', '金融科技公司G', 16, '2025-08-07'),
('算法工程师', 'AI公司H', 25, '2025-08-08'),
('销售经理', '贸易公司I', 12, '2025-08-09'),
('人力资源', '集团公司J', 9, '2025-08-10'),
('后端开发工程师', '科技有限公司A', 16, '2025-08-11'),
('大数据开发', '互联网公司B', 20, '2025-08-12'),
('架构师', '数据服务公司C', 30, '2025-08-13'),
('移动端开发', '软件公司E', 18, '2025-08-14'),
('DevOps工程师', '云服务公司F', 17, '2025-08-15'),
('数据科学家', 'AI公司H', 28, '2025-08-16'),
('市场专员', '贸易公司I', 8, '2025-08-17'),
('行政专员', '集团公司J', 7, '2025-08-18'),
('数据库工程师', '科技有限公司A', 19, '2025-08-19'),
('安全工程师', '互联网公司B', 22, '2025-08-20');

##rck用户切换到rck库
-- 在 rck 模式下创建成绩表
CREATE TABLE IF NOT EXISTS rck.score (
    id SERIAL PRIMARY KEY,             -- 自增ID
    student_id INT NOT NULL,           -- 学生ID
    student_name VARCHAR(50) NOT NULL, -- 学生姓名
    subject VARCHAR(30) NOT NULL,      -- 科目
    score NUMERIC(5,2) NOT NULL,       -- 成绩（支持小数）
    exam_date DATE NOT NULL            -- 考试日期
);

-- 设置当前会话默认使用 rck 模式
SET search_path TO rck;

-- 在rck模式下插入50条含唯一虚拟姓名的成绩数据
INSERT INTO rck.score (student_id, student_name, subject, score, exam_date) VALUES
(1001, '陈宇轩', '数学', 85.50, '2025-08-01'),
(1002, '林雨桐', '语文', 92.00, '2025-08-01'),
(1003, '王梓豪', '英语', 78.25, '2025-08-01'),
(1004, '张诗涵', '物理', 65.75, '2025-08-01'),
(1005, '李浩宇', '化学', 90.00, '2025-08-01'),
(1006, '刘思琪', '数学', 72.30, '2025-08-02'),
(1007, '赵俊辉', '语文', 88.10, '2025-08-02'),
(1008, '孙雨薇', '英语', 69.50, '2025-08-02'),
(1009, '周逸飞', '物理', 81.40, '2025-08-02'),
(1010, '吴佳怡', '化学', 76.80, '2025-08-02'),
(1011, '郑博文', '数学', 94.60, '2025-08-03'),
(1012, '马欣悦', '语文', 67.90, '2025-08-03'),
(1013, '朱梓睿', '英语', 83.20, '2025-08-03'),
(1014, '胡梦琪', '物理', 70.10, '2025-08-03'),
(1015, '郭天宇', '化学', 89.70, '2025-08-03'),
(1016, '何雨桐', '数学', 75.30, '2025-08-04'),
(1017, '高俊熙', '语文', 82.80, '2025-08-04'),
(1018, '罗思远', '英语', 91.50, '2025-08-04'),
(1019, '梁艺涵', '物理', 68.40, '2025-08-04'),
(1020, '宋子轩', '化学', 79.60, '2025-08-04'),
(1021, '唐雨欣', '数学', 87.20, '2025-08-05'),
(1022, '冯梓豪', '语文', 73.90, '2025-08-05'),
(1023, '于佳琪', '英语', 80.50, '2025-08-05'),
(1024, '董博文', '物理', 93.10, '2025-08-05'),
(1025, '萧雨薇', '化学', 66.80, '2025-08-05'),
(1026, '程逸飞', '数学', 78.40, '2025-08-06'),
(1027, '曹思琪', '语文', 85.70, '2025-08-06'),
(1028, '袁梓睿', '英语', 71.30, '2025-08-06'),
(1029, '邓梦琪', '物理', 89.90, '2025-08-06'),
(1030, '许天宇', '化学', 69.20, '2025-08-06'),
(1031, '付雨桐', '语文', 84.50, '2025-08-07'),
(1032, '沈俊辉', '英语', 77.80, '2025-08-07'),
(1033, '曾雨薇', '物理', 90.30, '2025-08-07'),
(1034, '彭逸飞', '化学', 72.60, '2025-08-07'),
(1035, '吕佳怡', '数学', 88.10, '2025-08-07'),
(1036, '苏博文', '语文', 65.90, '2025-08-08'),
(1037, '卢思远', '英语', 81.40, '2025-08-08'),
(1038, '蒋艺涵', '物理', 76.70, '2025-08-08'),
(1039, '蔡子轩', '化学', 92.20, '2025-08-08'),
(1040, '贾雨欣', '数学', 70.50, '2025-08-08'),
(1041, '丁梓豪', '英语', 86.80, '2025-08-09'),
(1042, '魏佳琪', '物理', 73.30, '2025-08-09'),
(1043, '薛梦琪', '化学', 89.60, '2025-08-09'),
(1044, '叶博文', '数学', 67.10, '2025-08-09'),
(1045, '阎雨薇', '语文', 82.40, '2025-08-09'),
(1046, '余逸飞', '物理', 79.70, '2025-08-10'),
(1047, '潘思琪', '化学', 85.30, '2025-08-10'),
(1048, '戴梓睿', '数学', 74.90, '2025-08-10'),
(1049, '夏天宇', '语文', 91.20, '2025-08-10'),
(1050, '钟雨欣', '英语', 68.50, '2025-08-10');

```

# 数据库备份

| 参数          | 含义                | 常见用途         |
| :---------- | :---------------- | :----------- |
| `-t 表名`     | 仅备份指定表            | 单表备份 / 迁移    |
| `-n 模式名`    | 仅备份指定模式           | 业务模式级备份      |
| `-Fc`       | 压缩二进制格式           | 高效备份 / 跨版本恢复 |
| `-Fp`       | 纯文本 SQL 格式        | 可读 / 可编辑的备份  |
| `--inserts` | 用 `INSERT` 语句备份数据 | 单条数据可修改      |
| `-s`        | 仅备份表结构            | 复制表结构        |
| `-a`        | 仅备份数据             | 单独备份数据内容     |

```shell
以压缩二进制格式，仅备份 zhaopin 数据库中 zhaopin 模式下的 job 表（包含表结构 + 数据）

备份多表
sys_dump -U 用户名 -d 数据库名 -f 备份文件路径 -Fc \
  -t 模式名.表名1 \
  -t 模式名.表名2 \
  -t 模式名.表名3

sys_dump -Uzhaopin -d zhaopin -f /tmp/table.dmp -Fc -t zhaopin.job


参数解析：
-U zhaopin：指定连接数据库的用户为 zhaopin。
-d zhaopin：指定要备份的数据库名为 zhaopin。
-f /tmp/table.dmp：指定备份文件输出路径和文件名（/tmp/table.dmp）。
-Fc：使用 Kingbase 自定义的 压缩格式（二进制）备份，支持跨版本恢复，体积小且恢复效率高。
-t zhaopin.job：仅备份指定的表 zhaopin.job（zhaopin 是模式名，job 是表名）。

```

```shell
以压缩二进制格式，备份 zhaopin 数据库中 zhaopin 模式下的所有对象（表结构 + 数据），但不包含其他模式（如 public、sysaudit 等）

备份多个模式
sys_dump -U 用户名 -d 数据库名 -f 备份文件路径 -Fc \
  -n 模式名1 \
  -n 模式名2 \
  -n 模式名3

sys_dump -Uzhaopin -d zhaopin -f /tmp/schema_zhaopin.dmp -Fc -n zhaopin


参数解析：
-U zhaopin：指定连接数据库的用户为 zhaopin。
-d zhaopin：指定要备份的数据库名为 zhaopin。
-f /tmp/schema_zhaopin.dmp：指定备份文件输出路径和文件名（/tmp/schema_zhaopin.dmp）。
-Fc：使用 Kingbase 自定义的 压缩格式（二进制）备份，支持跨版本恢复，体积小且恢复效率高。
-n zhaopin：仅备份指定的模式（Schema）zhaopin（包含模式下的所有表、视图、函数等对象）。

```

# 数据库恢复

```shell
恢复通过 -t zhaopin.job 备份的单表（表结构 + 数据）
sys_restore -U 用户名 -d 目标数据库 -v /tmp/table.dmp

# 恢复到 zhaopin 数据库（需先确保数据库存在）
sys_restore -Uzhaopin -d zhaopin -v /tmp/table.dmp

-U zhaopin：使用 zhaopin 用户连接数据库（需有恢复权限）。
-d zhaopin：指定恢复到 zhaopin 数据库（目标数据库必须已存在）。
-v：显示详细恢复过程（可选，用于查看进度）。
/tmp/table.dmp：备份文件路径。


恢复通过 -n zhaopin 备份的整个模式（包含模式下的所有表、视图、数据等）
# 恢复到 zhaopin 数据库
sys_restore -Uzhaopin -d zhaopin -v /tmp/schema_zhaopin.dmp

# 从模式备份中仅恢复 zhaopin.company 表
sys_restore -Uzhaopin -d zhaopin -v /tmp/schema_zhaopin.dmp -P zhaopin.company
-P：仅恢复指定对象（如只恢复模式中的某张表）

#将备份文件中的zhaopin模式下的对象还原到rck模式下面
sys_restore -Uzhaopin -d zhaopin /tmp/schema_zhaopin.dmp -Fc -g zhaopin -G rck
```

