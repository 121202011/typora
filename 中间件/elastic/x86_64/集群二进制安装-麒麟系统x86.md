| 名称      | 安装包下载地址                                                               |
| :------ | :-------------------------------------------------------------------- |
| elastic | <https://www.elastic.co/downloads/past-releases/elasticsearch-8-17-6> |

注意事项：

这里不用单独下载java，elastic安装包里面包含的有，直接调用就行。

7.13版本之前的elastic证书过期不影响集群间的通信，之后的版本证书过期就需要重新更新了，建议开始时候直接生成100年的

#### **先决条件**

```shell
配置用户或用户组资源限制
vim /etc/security/limits.conf
* hard nofile 131072
* soft nproc 2048
* hard nproc 4096

内核参数修改
vi /etc/sysctl.conf
vm.swappiness=1
vm.max_map_count=655360
fs.file-max = 204800

配置生效
sysctl -p

```

#### **安装包解压**

```shell
添加用户
useradd es

创建存储路径
mkdir -p /opt/elk
cd elasticsearch

安装包解压
tar -xf elasticsearch-8.17.6-linux-x86_64.tar.gz

添加软连接
ln -s elasticsearch-8.17.6 elasticsearch

添加环境变量
vim /etc/profile
##java##
export JAVA_HOME=/opt/elk/elasticsearch-8.17.6/jdk
export PATH=$JAVA_HOME/bin:$PATH

生效变量
source  /etc/profile

创建存储路径

mkdir /opt/elk/elasticsearch/data
```

#### **配置system管理**

```shell
vim /lib/systemd/system/elasticsearch.service
[Unit]
Description=elasticsearch
[Service]
User=es
LimitNOFILE=65535
ExecStart=/opt/elk/elasticsearch/bin/elasticsearch
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
[Install]
WantedBy=multi-user.target
```

#### 修改配置文件

```shell
#stand-alone
node.name: PRD-OPS-DEPLOY02
path.data: /opt/elk/elasticsearch/data
path.logs: /opt/elk/elasticsearch/logs
network.host: 0.0.0.0
http.port: 9200
transport.port: 9300
#discovery.type: single-node

#cluster
cluster.name: elastic-cluster
discovery.seed_hosts: ["172.24.99.209", "172.24.99.210", "172.24.99.211"]
cluster.initial_master_nodes: ['PRD-OPS-DEPLOY01']

#跨站访问
http.cors.enabled: true
http.cors.allow-origin: "*"
http.cors.allow-headers: Authorization

#node.roles: [ master, data, ingest ]

#xpack
xpack.security.enabled: true
xpack.security.enrollment.enabled: false

xpack.security.http.ssl:
  enabled: false
#  keystore.path: certs/http.p12

xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /opt/elk/elasticsearch/config/elastic-certificates.p12
  truststore.path: /opt/elk/elasticsearch/config/elastic-certificates.p12
```

#### **证书生成**

```bash
生成ca根证书（100年）
/opt/elk/elasticsearch/bin/elasticsearch-certutil ca --days 36500 --out ca.p12

根据ca根证书生成节点证书（100年）
/opt/elk/elasticsearch/bin/elasticsearch-certutil cert --ca ca.p12  --days 36500 --out elastic-certificates.p12

查看证书过期时间
openssl pkcs12 -in elastic-certificates.p12 -nodes -nokeys | openssl x509 -noout -dates

赋权
chmod +rx elastic-certificates.p12
mv elastic-certificates.p12 /opt/elk/elasticsearch/config
chown es:es -R /opt/elk

上传证书到其余两节点
scp /opt/elk/elasticsearch/config/elastic-certificates.p12 ciicsh-sudo@172.24.99.210:/tmp
scp /opt/elk/elasticsearch/config/elastic-certificates.p12 ciicsh-sudo@172.24.99.211:/tmp
```

#### **起服务**

```shell
起服务，开机自启，查看服务状态
systemctl start elasticsearch
systemctl enable elasticsearch
systemctl status elasticsearch
```

#### **设置密码**（jL7jnAEL,!Wq）

```shell
设置密码统一
/opt/elk/elasticsearch/bin/elasticsearch-setup-passwords interactive
```

#### **查看集群状态**

```shell
curl -u 'elastic':'jL7jnAEL,!Wq' '172.24.99.209:9200/_cat/health?v'
curl -u 'elastic':'jL7jnAEL,!Wq' '172.24.99.209:9200/_cat/nodes?v'
```

常见命令

```shell
修改密码
curl -H "Content-Type: application/json" -X POST -u elastic:'Belloai@123' '172.16.112.66:9200/_xpack/security/user/elastic/_password' -d '{ "password" : "Belloai_123" }'

```

